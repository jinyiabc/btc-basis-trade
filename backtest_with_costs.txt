# How to Add Comprehensive Costs to btc_basis_backtest.py

## Step 1: Add cost parameters to TradeConfig

In btc_basis_trade_analyzer.py, line ~32, modify TradeConfig:

@dataclass
class TradeConfig:
    """Configuration for basis trade"""
    account_size: float = 200_000
    spot_target_pct: float = 0.50
    futures_target_pct: float = 0.50
    funding_cost_annual: float = 0.05
    leverage: float = 1.0
    cme_contract_size: float = 5.0
    min_monthly_basis: float = 0.005

    # NEW: Trading cost parameters
    use_etf: bool = True  # True = ETF (IBIT), False = direct spot
    etf_commission_rate: float = 0.0005  # 0.05%
    spot_commission_rate: float = 0.004  # 0.4%
    futures_commission_per_contract: float = 2.00  # $2 per contract
    etf_slippage_rate: float = 0.0001  # 0.01%
    spot_slippage_rate: float = 0.0005  # 0.05%
    futures_slippage_rate: float = 0.0002  # 0.02%
    etf_expense_ratio_annual: float = 0.0025  # 0.25%


## Step 2: Modify backtest P&L calculation

In btc_basis_backtest.py, line ~228-238, replace with:

    # Calculate P&L
    # Long spot, short futures
    spot_pnl = (current_trade.exit_spot - current_trade.entry_spot) * current_trade.position_size
    futures_pnl = (current_trade.entry_futures - current_trade.exit_futures) * current_trade.position_size

    # === NEW: Calculate all costs ===

    # 1. Entry commissions
    if self.config.use_etf:
        entry_commission = (current_trade.entry_spot * current_trade.position_size *
                          self.config.etf_commission_rate)
    else:
        entry_commission = (current_trade.entry_spot * current_trade.position_size *
                          self.config.spot_commission_rate)

    contracts = current_trade.position_size / self.config.cme_contract_size
    entry_commission += contracts * self.config.futures_commission_per_contract

    # 2. Exit commissions
    if self.config.use_etf:
        exit_commission = (current_trade.exit_spot * current_trade.position_size *
                         self.config.etf_commission_rate)
    else:
        exit_commission = (current_trade.exit_spot * current_trade.position_size *
                         self.config.spot_commission_rate)

    exit_commission += contracts * self.config.futures_commission_per_contract

    # 3. Slippage costs
    if self.config.use_etf:
        entry_slippage = (current_trade.entry_spot * current_trade.position_size *
                        self.config.etf_slippage_rate)
        exit_slippage = (current_trade.exit_spot * current_trade.position_size *
                       self.config.etf_slippage_rate)
    else:
        entry_slippage = (current_trade.entry_spot * current_trade.position_size *
                        self.config.spot_slippage_rate)
        exit_slippage = (current_trade.exit_spot * current_trade.position_size *
                       self.config.spot_slippage_rate)

    futures_slippage = (current_trade.entry_futures * current_trade.position_size *
                       self.config.futures_slippage_rate +
                       current_trade.exit_futures * current_trade.position_size *
                       self.config.futures_slippage_rate)

    # 4. Funding cost (existing)
    holding_days_actual = (current_trade.exit_date - current_trade.entry_date).days
    funding_cost = (self.config.funding_cost_annual / 365) * holding_days_actual * \
                  (current_trade.entry_spot * current_trade.position_size)

    # 5. ETF expense ratio (if using ETF)
    etf_expense = 0
    if self.config.use_etf:
        etf_expense = (self.config.etf_expense_ratio_annual / 365) * holding_days_actual * \
                     (current_trade.entry_spot * current_trade.position_size)

    # Total costs
    total_costs = (entry_commission + exit_commission +
                  entry_slippage + exit_slippage + futures_slippage +
                  funding_cost + etf_expense)

    current_trade.realized_pnl = spot_pnl + futures_pnl - total_costs


## Step 3: Store cost breakdown in Trade object

In btc_basis_backtest.py, modify Trade dataclass (line ~29):

@dataclass
class Trade:
    """Represents a single basis trade"""
    entry_date: datetime
    entry_spot: float
    entry_futures: float
    entry_basis: float
    exit_date: Optional[datetime] = None
    exit_spot: Optional[float] = None
    exit_futures: Optional[float] = None
    exit_basis: Optional[float] = None
    position_size: float = 1.0
    funding_cost: float = 0.0
    realized_pnl: Optional[float] = None
    status: str = "open"

    # NEW: Cost breakdown
    entry_commission: float = 0.0
    exit_commission: float = 0.0
    slippage_cost: float = 0.0
    etf_expense: float = 0.0
    total_costs: float = 0.0


## Step 4: Test the enhanced backtest

python btc_basis_backtest.py --data converging_basis_2024.csv --holding-days 30

Expected output should now show lower returns due to realistic costs!


## Cost Impact Comparison

Original (funding only):
- Gross P&L: $1,000
- Funding: -$205
- Net: $795 (1.59% / 19% annualized)

Enhanced (all costs, ETF route):
- Gross P&L: $1,000
- All costs: -$297
- Net: $703 (1.41% / 17% annualized)

Enhanced (all costs, direct spot):
- Gross P&L: $1,000
- All costs: -$676
- Net: $324 (0.65% / 8% annualized)
